version: '3.8'

services:
  # 1. Database (MySQL 8.0)
  db:
    image: mysql:8.0
    container_name: easyfin-mysql
    restart: unless-stopped
    # DB 컨테이너가 정상적으로 시작될 때까지 기다리기 위한 Healthcheck
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u$$MYSQL_USER", "-p$$MYSQL_PASSWORD"]
      interval: 5s
      timeout: 10s
      retries: 5
    environment:
      # [변경] 초기화/실행 모두에 사용되는 표준 환경 변수 명시
      MYSQL_ROOT_PASSWORD: rootpassword
      # 초기화 오류를 피하기 위해 INITDB 사용을 권장합니다.
    
      MYSQL_DATABASE: easyfin_db
      MYSQL_USER: easyfin
      MYSQL_PASSWORD: easyfin
      TZ: Asia/Seoul
    volumes:
      - mysql_data:/var/lib/mysql # 영구 데이터 저장을 위한 볼륨
    ports:
      # 호스트:컨테이너 포트. 33060이 충돌 시 33061 등으로 변경하세요.
      - "33061:3306" 

  # 2. Backend (FastAPI + Uvicorn)
  backend:
    build:
      context: . # 현재 디렉토리(.env, Dockerfile.backend가 있는 곳)
      dockerfile: Dockerfile.backend
    container_name: easyfin-backend
    restart: unless-stopped
    # DB가 준비될 때까지 기다립니다.
    depends_on:
      db:
        condition: service_healthy
    environment:
      # SQLAlchemy 연결 문자열: db 서비스 이름과 환경 변수 사용
      DATABASE_URL: mysql+pymysql://easyfin:easyfin@db:3306/easyfin_db
    ports:
      - "8000:8000" # FastAPI 포트
    volumes:
      - ./backend:/app/backend # 코드 변경 시 컨테이너 재빌드 없이 반영

  # 3. Frontend (Nginx for Static Files)
  frontend:
    image: nginx:alpine
    container_name: easyfin-frontend
    restart: unless-stopped
    volumes:
      # 프론트엔드 HTML, CSS, JS 파일을 Nginx 기본 디렉토리에 마운트
      - ./frontend:/usr/share/nginx/html:ro
    ports:
      - "3000:80" # 호스트 3000번 포트로 웹 접속
    depends_on:
      - backend

# Docker 볼륨 정의
volumes:
  mysql_data: